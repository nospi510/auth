{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2>V√©rification Faciale</h2>

    {% if current_user.face_verified %}
        <p>Votre visage est d√©j√† v√©rifi√©.</p>
        <a href="{{ url_for('auth.dashboard') }}" class="btn btn-primary">Acc√©der au tableau de bord</a>
    {% else %}
        <p>Veuillez effectuer la v√©rification faciale ci-dessous.</p>

        <div class="video-container">
            <video id="webcam" autoplay></video>
            <canvas id="canvas" style="display:none;"></canvas>
        </div>

        <button id="capture-btn" class="btn btn-primary" disabled>Capturer</button>

        <form id="verify-form" method="POST" action="{{ url_for('auth.verify_face_route') }}" style="display: none;">
            <input type="hidden" id="face_image" name="face_data">
            <button type="submit" class="btn btn-success">Soumettre la v√©rification</button>
        </form>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async function () {
    const video = document.getElementById("webcam");
    const captureBtn = document.getElementById("capture-btn");
    const faceInput = document.getElementById("face_image");
    const verifyForm = document.getElementById("verify-form");

    // üîÑ Charger les mod√®les directement en local
    async function loadModels() {
        try {
            console.log("üîÑ Chargement des mod√®les avec Tiny Face Detector...");
            
            // Charger Tiny Face Detector au lieu de SSD Mobilenet
            await faceapi.nets.tinyFaceDetector.loadFromUri('/app/static/models/tiny_face_detector');
            await faceapi.nets.faceLandmark68Net.loadFromUri('/app/static/models/face_landmark_68');
            await faceapi.nets.faceRecognitionNet.loadFromUri('/app/static/models/face_recognition');

            console.log("‚úÖ Mod√®les charg√©s avec succ√®s !");
        } catch (error) {
            console.error("‚ùå Erreur lors du chargement des mod√®les :", error);
            alert("Impossible de charger les mod√®les de reconnaissance faciale.");
        }
    }

    await loadModels();

    // üì∑ Activer la webcam
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        console.log("üé• Cam√©ra activ√©e !");
    } catch (err) {
        console.error("‚ùå Erreur d'acc√®s √† la cam√©ra :", err);
        alert("Impossible d'acc√©der √† la cam√©ra. V√©rifiez vos permissions.");
        return;
    }

    // üîç V√©rification faciale en temps r√©el
    setInterval(async () => {
        if (video.readyState !== 4) return; // V√©rifie si la vid√©o est pr√™te

        const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceDescriptor();

        if (detection) {
            captureBtn.disabled = false;
            console.log("üôÇ Visage d√©tect√© !");
        } else {
            captureBtn.disabled = true;
        }
    }, 500);

    // üì∏ Capture et soumission
    captureBtn.addEventListener("click", async function () {
        const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceDescriptor();

        if (detection) {
            faceInput.value = JSON.stringify(detection.descriptor); // Stocker les donn√©es faciales
            verifyForm.style.display = "block";
            console.log("‚úÖ Visage captur√© !");
        } else {
            alert("Aucun visage d√©tect√©, essayez encore.");
        }
    });

});
</script>

{% endblock %}
